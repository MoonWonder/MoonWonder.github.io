{{ $currentYear := now.Year }}
{{ $pageLang := .Page.Lang }}
{{ $defaultSections := slice "posts" "life" }}
{{ $includeSections := $defaultSections }}
{{ $normalizeScratch := newScratch }}
{{ with site.Params.heatmap }}
    {{ with .sections }}
        {{ $normalizeScratch.Set "sections" (slice) }}
        {{ if eq (printf "%T" .) "string" }}
            {{ range (split . ",") }}
                {{ $trimmed := strings.TrimSpace . }}
                {{ if $trimmed }}
                    {{ $normalizeScratch.Set "sections" (append ($normalizeScratch.Get "sections") $trimmed) }}
                {{ end }}
            {{ end }}
        {{ else }}
            {{ range . }}
                {{ $value := strings.TrimSpace (printf "%v" .) }}
                {{ if $value }}
                    {{ $normalizeScratch.Set "sections" (append ($normalizeScratch.Get "sections") $value) }}
                {{ end }}
            {{ end }}
        {{ end }}
        {{ if gt (len ($normalizeScratch.Get "sections")) 0 }}
            {{ $includeSections = $normalizeScratch.Get "sections" }}
        {{ end }}
    {{ end }}
{{ end }}

{{ with .Get "sections" }}
    {{ $normalizeScratch.Set "sections" (slice) }}
    {{ range (split . ",") }}
        {{ $trimmed := strings.TrimSpace . }}
        {{ if $trimmed }}
            {{ $normalizeScratch.Set "sections" (append ($normalizeScratch.Get "sections") $trimmed) }}
        {{ end }}
    {{ end }}
    {{ if gt (len ($normalizeScratch.Get "sections")) 0 }}
        {{ $includeSections = $normalizeScratch.Get "sections" }}
    {{ end }}
{{ end }}

{{ if gt (len $includeSections) 0 }}
    {{ $includeSections = sort $includeSections }}
{{ else }}
    {{ $includeSections = $defaultSections }}
{{ end }}

{{ if eq (len $includeSections) 0 }}
    {{ $includeSections = $defaultSections }}
{{ end }}

{{ $pages := where .Page.Site.RegularPages "Lang" $pageLang }}
{{ if gt (len $includeSections) 0 }}
    {{ $pages = where $pages "Section" "in" $includeSections }}
{{ end }}
{{ $pages = where $pages "Date.Year" $currentYear }}
{{ $pages = sort $pages "Date" }}

{{ $pageCount := len $pages }}
{{ $aggregatedWords := 0 }}
{{ range $pages }}
    {{ $aggregatedWords = add $aggregatedWords .WordCount }}
{{ end }}
{{ $aggregatedCount := $pageCount }}
{{ $grouped := $pages.GroupByDate "2006-01-02" }}
{{ $uniqueDayCount := len $grouped }}
{{ $sectionsJSON := $includeSections | jsonify }}
{{ $verificationJSON := dict "expectedPages" $pageCount "aggregatedPages" $aggregatedCount "totalWords" $aggregatedWords "uniqueDays" $uniqueDayCount | jsonify }}

<!-- Cal-Heatmap assets -->
<div>
    <h2>{{ i18n "heatmap.postsHeading" }}</h2>
    <div id="posts-heatmap" style="width: 100%; overflow-x: auto;"></div>

    <h2>{{ i18n "heatmap.wordsHeading" }}</h2>
    <div id="words-heatmap" style="width: 100%; overflow-x: auto;"></div>
</div>

<!-- heatmap-verify: lang={{ $pageLang }}, year={{ $currentYear }}, sections={{ delimit $includeSections ", " }}, qualifyingPages={{ $pageCount }}, aggregatedPages={{ $aggregatedCount }}, uniqueDays={{ $uniqueDayCount }}, totalWords={{ $aggregatedWords }} -->

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/cal-heatmap/dist/cal-heatmap.css" />

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', async function() {
    const currentYear = {{ $currentYear }};
    const postsData = [];
    const wordsData = [];
{{ range $grouped }}
    {{ $count := len .Pages }}
    {{ $dayWords := 0 }}
    {{ range .Pages }}
        {{ $dayWords = add $dayWords .WordCount }}
    {{ end }}
    postsData.push({ date: "{{ .Key }}", value: {{ $count }} });
    wordsData.push({ date: "{{ .Key }}", value: {{ $dayWords }} });
{{ end }}
    const sectionsUsed = {{ $sectionsJSON | safeJS }};
    const heatmapVerification = {{ $verificationJSON | safeJS }};
    const postsTooltipTemplate = {{ (i18n "heatmap.postsTooltip") | jsonify | safeJS }};
    const wordsTooltipTemplate = {{ (i18n "heatmap.wordsTooltip") | jsonify | safeJS }};
    const verificationMessageTemplate = {{ (i18n "heatmap.verificationMessage") | jsonify | safeJS }};
    const verificationSummaryTemplate = {{ (i18n "heatmap.verificationSummary") | jsonify | safeJS }};
    const metricPostsLabel = {{ (i18n "heatmap.metricPosts") | jsonify | safeJS }};
    const metricWordsLabel = {{ (i18n "heatmap.metricWords") | jsonify | safeJS }};

    const formatTemplate = (template, replacements) => {
        let result = template;
        Object.entries(replacements).forEach(([key, value]) => {
            const pattern = new RegExp(`\\{${key}\\}`, 'g');
            result = result.replace(pattern, value);
        });
        return result;
    };

    const aggregatedCount = postsData.reduce((sum, item) => sum + (item.value || 0), 0);
    const aggregatedWordTotal = wordsData.reduce((sum, item) => sum + (item.value || 0), 0);
    const sharedReplacements = {
        year: currentYear,
        sections: sectionsUsed.join(', '),
        days: heatmapVerification.uniqueDays
    };

    const postsMismatchMessage = formatTemplate(verificationMessageTemplate, {
        ...sharedReplacements,
        metric: metricPostsLabel,
        expected: heatmapVerification.expectedPages,
        actual: aggregatedCount
    });

    const wordsMismatchMessage = formatTemplate(verificationMessageTemplate, {
        ...sharedReplacements,
        metric: metricWordsLabel,
        expected: heatmapVerification.totalWords,
        actual: aggregatedWordTotal
    });

    console.assert(aggregatedCount === heatmapVerification.expectedPages, postsMismatchMessage);
    console.assert(aggregatedWordTotal === heatmapVerification.totalWords, wordsMismatchMessage);

    const postsSummaryMessage = formatTemplate(verificationSummaryTemplate, {
        ...sharedReplacements,
        metric: metricPostsLabel,
        value: aggregatedCount
    });
    const wordsSummaryMessage = formatTemplate(verificationSummaryTemplate, {
        ...sharedReplacements,
        metric: metricWordsLabel,
        value: aggregatedWordTotal
    });

    console.info(postsSummaryMessage);
    console.info(wordsSummaryMessage);

    const postsHeatmap = new CalHeatmap();
    const startDate = new Date(currentYear, 0, 1);

    await postsHeatmap.paint({
        itemSelector: '#posts-heatmap',
        range: 12,
        domain: {
            type: 'month',
            gutter: 4,
            label: { text: 'MMM', textAlign: 'start', position: 'top' }
        },
        subDomain: {
            type: 'day',
            width: 12,
            height: 12,
            gutter: 2,
            radius: 2
        },
        data: {
            source: postsData,
            type: 'json',
            x: 'date',
            y: 'value'
        },
        date: { start: startDate },
        scale: {
            color: {
                type: 'threshold',
                range: ['#efefef', '#c6e48b', '#7bc96f', '#239a3b', '#196127'],
                domain: [1, 2, 3, 5]
            }
        },
        tooltip: {
            enabled: true,
            text: function(date, value, dayjsDate) {
                return formatTemplate(postsTooltipTemplate, {
                    date: dayjsDate.format('YYYY-MM-DD'),
                    count: value || 0
                });
            }
        }
    });

    const wordsHeatmap = new CalHeatmap();
    await wordsHeatmap.paint({
        itemSelector: '#words-heatmap',
        range: 12,
        domain: {
            type: 'month',
            gutter: 4,
            label: { text: 'MMM', textAlign: 'start', position: 'top' }
        },
        subDomain: {
            type: 'day',
            width: 12,
            height: 12,
            gutter: 2,
            radius: 2
        },
        data: {
            source: wordsData,
            type: 'json',
            x: 'date',
            y: 'value'
        },
        date: { start: startDate },
        scale: {
            color: {
                type: 'threshold',
                range: ['#efefef', '#fdcfcf', '#fc9898', '#f06060', '#d6001c'],
                domain: [1000, 5000, 10000, 30000]
            }
        },
        tooltip: {
            enabled: true,
            text: function(date, value, dayjsDate) {
                return formatTemplate(wordsTooltipTemplate, {
                    date: dayjsDate.format('YYYY-MM-DD'),
                    count: value || 0
                });
            }
        }
    });
});
</script>
